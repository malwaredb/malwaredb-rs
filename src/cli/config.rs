#![allow(unused)]

use server::State;

use std::fmt::{Debug, Formatter};
use std::net::IpAddr;

use anyhow::Context;
use clap::Parser;
use serde::{Deserialize, Deserializer};
use zeroize::Zeroizing;

#[derive(Clone, Parser, PartialEq, Deserialize)]
pub struct Config {
    /// The port which will be used to listen for connections.
    #[arg(short, long, default_value = "8443")]
    pub port: u16,

    /// The directory to store malware samples, if we're keeping them.
    #[arg(long)]
    pub dir: Option<String>,

    /// IP address to use for listening for connections
    #[arg(short, long, default_value = "127.0.0.1")]
    pub ip: IpAddr,

    /// Database connection string
    #[arg(long)]
    #[serde(deserialize_with = "from_db_string")]
    pub db: Zeroizing<String>,
}

fn from_db_string<'de, D>(deserializer: D) -> Result<Zeroizing<String>, D::Error>
where
    D: Deserializer<'de>,
{
    let s: String = Deserialize::deserialize(deserializer)?;

    Ok(Zeroizing::new(s))
}

impl Config {
    pub fn state(&self) -> anyhow::Result<State> {
        State::new(self.port, self.dir.clone(), self.ip, &self.db)
    }

    pub fn from_file(path: &std::path::PathBuf) -> anyhow::Result<Self> {
        let config = std::fs::read_to_string(path)
            .context(format!("failed to read config file {}", path.display()))?;
        let cfg: Config = toml::from_str(&config)
            .context(format!("failed to parse config file {}", path.display()))?;
        Ok(cfg)
    }
}

impl Debug for Config {
    fn fmt(&self, f: &mut Formatter<'_>) -> std::fmt::Result {
        write!(f, "MalwareDB listening on {}:{}", self.ip, self.port)?;
        match &self.dir {
            Some(path) => write!(f, " saving files to {}", path),
            None => write!(f, " not saving files"),
        }
    }
}
