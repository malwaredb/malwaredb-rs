use super::config::Config;
use server::State;

use std::process::ExitCode;

use clap::{Parser, Subcommand};

/// Malware Database Server
#[derive(Clone, Parser, Debug, PartialEq)]
pub struct Run {
    #[clap(subcommand)]
    pub cmd: Subcommands,
}

impl Run {
    pub fn state(&self) -> anyhow::Result<State> {
        let cfg = match &self.cmd {
            Subcommands::Load(loader) => loader.config()?,
            Subcommands::Config(config) => config.clone(),
        };

        State::new(cfg.port, cfg.dir.clone(), cfg.ip, &cfg.db)
    }

    pub fn execute(&self) -> anyhow::Result<ExitCode> {
        let _state = self.state()?;
        println!("Hello, world!");
        Ok(ExitCode::SUCCESS)
    }
}

#[derive(Clone, Parser, Debug, PartialEq)]
pub struct Load {
    #[arg(value_name = "FILE", value_hint = clap::ValueHint::FilePath)]
    file: std::path::PathBuf,
}

impl Load {
    pub fn config(&self) -> anyhow::Result<Config> {
        Config::from_file(&self.file)
    }
}

#[derive(Subcommand, Clone, Debug, PartialEq)]
pub enum Subcommands {
    Load(Load),
    Config(Config),
}
