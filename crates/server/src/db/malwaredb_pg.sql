CREATE TABLE file (
    id bigserial NOT NULL,
    sha1 text NOT NULL,
    sha256 text NOT NULL,
    sha512 text NOT NULL UNIQUE,
    md5 text NOT NULL,
    lzjd text,
    ssdeep text,
    sdhash text,
    tlsh text,
    createddate timestamp with time zone NOT NULL DEFAULT current_timestamp,
    filetypeid integer NOT NULL,
    size integer NOT NULL,
    entropy real NOT NULL,
    confirmedmalicious boolean,
    PRIMARY KEY (id)
);


CREATE TABLE executable (
    fileid bigint NOT NULL REFERENCES file(id),
    pehash text,
    importhash text,
    importhashfuzzy text,
    packed boolean,
    sections integer NOT NULL,
    sectionnames text[],
    sectionentropies real[],
    sectionexec boolean[],
    PRIMARY KEY (fileid)
);


CREATE TABLE pdf (
    fileid bigint NOT NULL REFERENCES file(id),
    pages int,
    streams int,
    javascript int,
    openAction int,
    largeColourSpace boolean,
    embeddedFiles int,
    PRIMARY KEY (fileid)
);


CREATE TABLE label (
    id bigserial NOT NULL,
    name text NOT NULL UNIQUE,
    PRIMARY KEY (id)
);


CREATE TABLE source (
    id serial NOT NULL,
    name text NOT NULL UNIQUE,
    description text,
    url text,
    firstacquisition timestamp with time zone NOT NULL,
    releasable boolean NOT NULL,
    PRIMARY KEY (id)
);


CREATE TABLE filelabel (
    fileid bigint NOT NULL REFERENCES file(id),
    labelid bigint NOT NULL REFERENCES label(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, labelid)
);


CREATE TABLE sourcelabel (
    sourceid int NOT NULL REFERENCES source(id),
    labelid bigint NOT NULL REFERENCES label(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (sourceid, labelid)
);


CREATE TABLE grp (
    id serial NOT NULL,
    name text NOT NULL CONSTRAINT name_unique UNIQUE,
    description text,
    parent integer references grp(id),
    PRIMARY KEY (id)
);


CREATE TABLE person (
    id serial NOT NULL,
    email text NOT NULL UNIQUE,
    uname text NOT NULL UNIQUE,
    firstname text NOT NULL,
    lastname text NOT NULL,
    organisation text,
    phone text,
    password text,
    apikey text UNIQUE,
    created timestamp with time zone NOT NULL DEFAULT current_timestamp,
    PRIMARY KEY (id)
);


CREATE TABLE filesource (
    fileid bigint NOT NULL REFERENCES file(id),
    sourceid int NOT NULL REFERENCES source(id),
    userid int NOT NULL REFERENCES person(id),
    filename text[] NOT NULL,
    firstseen timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, sourceid)
);


CREATE TABLE mdbconfig (
    version real NOT NULL,
    name text NOT NULL,
    defaultFileSource int references source(id)
);


CREATE TABLE filetype (
    id serial NOT NULL,
    name text NOT NULL UNIQUE,
    description text,
    magic bytea[] NOT NULL UNIQUE,
    executable boolean,
    PRIMARY KEY (id)
);


INSERT INTO filetype(name,description,magic,executable) VALUES
('PE32', '.EXEs and other Windows executables', ARRAY[E'\\x4d5a'::bytea, E'\\x5a4d'::bytea], true),
('ELF', 'Executable and Linkable Format, used for applications and libraries on Linux, BSD, Solaris, Haiku, and other OSes', ARRAY[E'\\x7f454c46'::bytea], true),
('Mach-O', 'mac OS executable format for applications, frameworks, and libraries', ARRAY[E'\\xFEEDFACE'::bytea, E'\\xFEEDFACF', E'\\xCEFAEDFE'::bytea, E'\\xCFFAEDFE'::bytea], true),
('Fat Mach-O', 'mac OS executable format for applications, frameworks, and libraries', ARRAY[E'\\xCAFEBABE'::bytea], true),
('PDF', 'Adobe Portable Document Format (PDF)', ARRAY[E'\\x25504446'::bytea], false),
('Office97', 'Microsoft Office 97 and other types (Compound Document Format)', ARRAY[E'\\xD0CF11E0'::bytea], false),
('RTF', 'Rich Text Format (RTF)', ARRAY[E'\\x7b5c727466'::bytea], false);


INSERT INTO PERSON VALUES(0, 'admin@example.com', 'admin', 'ADMIN', 'USER', NULL, NULL, NULL, NULL, current_timestamp);

CREATE TABLE polyglot (
    fileid bigint NOT NULL REFERENCES file(id),
    filetypeid integer NOT NULL REFERENCES filetype(id),
    explaination text,
    PRIMARY KEY (fileid, filetypeid)
);

CREATE TABLE groupsource (
     gid integer NOT NULL REFERENCES grp(id),
     sourceid int NOT NULL REFERENCES source(id),
     PRIMARY KEY(gid, sourceid)
);

CREATE TABLE usergroup (
    pid integer NOT NULL REFERENCES person(id),
    gid integer NOT NULL REFERENCES grp(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (pid, gid)
);

INSERT INTO grp(id, name, description) VALUES(0, 'admin', 'Administrative users');
INSERT INTO usergroup VALUES(0, 0, current_timestamp);

CREATE TABLE vtclean (
    fileid bigint NOT NULL REFERENCES file(id),
    tstamp timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, tstamp)
);


CREATE TABLE vthits (
    fileid bigint NOT NULL REFERENCES file(id),
    tstamp timestamp with time zone NOT NULL,
    hits integer NOT NULL,
    vtdetail json[],
    PRIMARY KEY (fileid, tstamp)
);


