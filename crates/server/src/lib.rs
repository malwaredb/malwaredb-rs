pub mod db;
pub mod http;
pub mod processing;
pub mod types;
pub mod utils;

use api::ServerInfo;
use utils::HashPath;

use std::net::{IpAddr, SocketAddr};
use std::path::PathBuf;
use std::str::FromStr;
use std::time::{Duration, SystemTime};

use anyhow::{bail, Result};
use duration_string::DurationString;
use sha2::{Digest, Sha256};
use zeroize::Zeroizing;

/// MDB version
pub const MDB_VERSION: &str = env!("CARGO_PKG_VERSION");

static mut GLOBAL_STATE: Option<State> = None;

pub struct State {
    /// The port which will be used to listen for connections.
    pub port: u16,

    /// The directory to store malware samples, if we're keeping them.
    pub directory: Option<PathBuf>,

    /// The IP to use for listening for connections
    pub ip: IpAddr,

    /// Database connection string
    pub database_connection: Zeroizing<String>,

    /// Handle to the database connection
    pub db_type: db::DatabaseType,

    /// Start time of the server
    pub started: SystemTime,
}

impl State {
    pub async fn new(
        port: u16,
        directory: Option<String>,
        ip: IpAddr,
        db_string: String,
    ) -> Result<Self> {
        let directory = if let Some(dir) = &directory {
            let the_dir = PathBuf::from_str(dir)?;
            if !the_dir.exists() {
                bail!("data directory {dir} does not exist!");
            }
            Some(the_dir)
        } else {
            None
        };

        unsafe {
            GLOBAL_STATE = Some(Self {
                port,
                directory: directory.clone(),
                ip,
                db_type: db::DatabaseType::from_string(&db_string).await?,
                database_connection: Zeroizing::new(db_string.clone()),
                started: SystemTime::now(),
            });
        }

        Ok(Self {
            port,
            directory,
            ip,
            db_type: db::DatabaseType::from_string(&db_string).await?,
            database_connection: Zeroizing::new(db_string),
            started: SystemTime::now(),
        })
    }

    pub(crate) fn get_state() -> Result<&'static State> {
        unsafe {
            if GLOBAL_STATE.is_none() {
                bail!("no configuration loaded")
            }
            Ok(GLOBAL_STATE.as_ref().unwrap())
        }
    }

    /// Store the sample with a depth of three based on the sample's SHA-256 hash
    /// In the future, the depth and hash function could be configured and saved in the database.
    /// But a change of this configuration would require visiting and reprocessing all previously-stored files!
    pub fn store_bytes(&self, data: &[u8]) -> Result<bool> {
        if let Some(dest_path) = &self.directory {
            let mut hasher = Sha256::new();
            hasher.update(data);
            let result = hasher.finalize();

            let hashed_path = result.hashed_path(3);
            let mut dest_path = dest_path.clone();
            dest_path.push(hashed_path);

            std::fs::write(dest_path, data)?;
            Ok(true)
        } else {
            Ok(false)
        }
    }

    pub fn since(&self) -> Duration {
        let now = SystemTime::now();
        now.duration_since(self.started).unwrap()
    }

    pub async fn get_info(&self) -> Result<ServerInfo> {
        let db_info = self.db_type.db_info().await?;

        let os_name = if cfg!(target_os = "linux") {
            "Linux"
        } else if cfg!(target_os = "macos") {
            "macOS"
        } else if cfg!(target_os = "windows") {
            "Windows"
        } else if cfg!(target_os = "freebsd") {
            "FreeBSD"
        } else if cfg!(target_os = "openbsd") {
            "OpenBSD"
        } else if cfg!(target_os = "netbsd") {
            "NetBSD"
        } else if cfg!(target_os = "wasi") {
            "WebAssembly WASI"
        } else {
            "unknown"
        };

        let mem_size = if cfg!(target_family = "unix") {
            if let Ok(statm) = std::fs::read_to_string("/proc/self/statm") {
                let mut parts = statm.split(' ');
                if let Some(total_memory) = parts.next() {
                    if let Ok(memory_integer) = u64::from_str(total_memory) {
                        humansize::SizeFormatter::new(memory_integer, humansize::BINARY).to_string()
                    } else {
                        "".into()
                    }
                } else {
                    "".into()
                }
            } else {
                "".into()
            }
        } else {
            "".into()
        };

        Ok(ServerInfo {
            os_name: os_name.into(),
            os_version: "".to_string(),
            memory_used: mem_size,
            num_samples: db_info.num_files,
            num_users: db_info.num_users,
            uptime: DurationString::from(self.since()),
            mdb_version: MDB_VERSION.into(),
            db_version: db_info.version,
            db_size: db_info.size,
        })
    }

    pub async fn serve(self) -> Result<()> {
        let socket = SocketAddr::new(self.ip, self.port);
        println!("Listening on {socket:?}");
        axum::Server::bind(&socket)
            .serve(http::app(self).into_make_service())
            .await?;

        Ok(())
    }
}

pub fn init_tracing() {
    if std::env::var("RUST_LOG_JSON").is_ok() {
        tracing_subscriber::fmt::fmt()
            .json()
            .with_env_filter(tracing_subscriber::EnvFilter::from_default_env())
            .init();
    } else {
        tracing_subscriber::fmt::init();
    }
}
