use crate::db::types::FileMetadata;
use crate::State;
use malwaredb_types::KnownType;
use std::io::Cursor;

use std::sync::Arc;

use anyhow::{bail, Result};
use tracing::{error, instrument, trace};

pub const CART_MAGIC: [u8; 4] = [0x43, 0x41, 0x52, 0x54];

#[instrument]
pub async fn incoming_sample(
    state: Arc<State>,
    data: Vec<u8>,
    uid: i32,
    sid: i32,
    file_name: String,
) -> Result<()> {
    let data = if data[0..4] == CART_MAGIC {
        let mut output = Cursor::new(vec![]);
        let bytes_input = Cursor::new(data);
        cart_container::unpack_stream(bytes_input, &mut output, None)?;
        trace!("Received CaRT file and decoded it's contents.");
        output.into_inner()
    } else {
        data
    };

    let known_type = match KnownType::new(&data) {
        Ok(t) => t,
        Err(e) => {
            error!("Error determining type: {e}");
            return Err(e);
        }
    };

    let meta_data = FileMetadata::new(&data, Some(&file_name));

    let db_file_type = match state.db_type.get_type_id_for_bytes(&data).await {
        Ok(t) => t,
        Err(e) => {
            error!("db_file_type error or is none: {e}");
            bail!("file type unknown or error: {e}");
        }
    };

    match state
        .db_type
        .add_file(&meta_data, known_type, uid, sid, db_file_type, None)
        .await
    {
        Ok(_) => {
            trace!("Storing sample!");
            if let Err(e) = state.store_bytes(&data).await {
                error!("Error storing sample: {e}");
                Err(e)
            } else {
                Ok(())
            }
        }
        Err(e) => {
            error!("Error storing bytes: {e}");
            Err(e)
        }
    }
}
